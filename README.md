# defacing
MRI anonymization algorithm

This code removes the face from an MRI in a three-step procedure based on John Ashburner's and Karl Friston's "Unified segmentation" algorithm (for more details see the paper https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9598466/)

* In a first step, the MRI is non-linearly realigned to MNI space, using as target the whole-head tissue probability map "NY-head" (ICBM-NY, https://www.parralab.org/nyhead/).
* In a second step, the tissue probabily map is replaced by a version including the face as a separated tissue, and the face tissue is sampled into the original MRI.
* Last, the face tissue (probability higher than 10%) is removed (for the "deftrim" version) or blurred (for the "def" version).

## Preparing the input

For the initial realignment to work properly the MRI must be in a close-to-ACPC space (this is, a RAS-oriented image with the origin of the system of coordinates in the anterior commisure and the Y-axis passing through the posterior commisure).

The code includes three ways to change the system of coordinates:
1. Using a fiducial definition for the AC-PC coordinate system, as used by FieldTrip.
2. Using a transformation to Tailarach space, as generated by FreeSurfer.
3. Using a first rigid-body transformation to the MNI template.

If the original MRI is in AC-PC space these steps are not required, but the code assumes the MRI images in native (arbitrary) coordinates.

### 1. Fiducial definition

The fiducial definition must be provided in a MAT file, located in the T1 folder, and with the same name (without the extension) that the MRI file (followed by the .mat extension).

The file must contain, at least, three variables:
* _ac_, with the position (in voxel coordinates) of the anterior commisure.
* _pc_, with the position (in voxel coordinates) of the posterior commisure.
* _xzpoint_, with the position (in voxel coordinates) of a point in the positive Z values of the XY plane (interhemispheric point above both ac and pc).

See https://www.fieldtriptoolbox.org/reference/ft_volumerealign/ for a more detailed description.

### 2. Transformation to Tailarach space

The transformation matrix must be provided in a XFM (FreeSurfer transformation) file, located in the T1 folder, and with the same name (without the extension) that the MRI file (followed by the _nat2tal appendix and the .xfm extension).

If FreeSurfer is available, the transformation can be automatically generated using the _nat2tal.sh_ bash script.

### 3. Automatic rigid-body transformation

This is a last-resort, and requires no data input.

## Things to take into account:
* The code requires FieldTrip (tested with versions though 2019 and 2020) to work.
* The folder _spm12_functions_ contains a subset of SPM12 functions with some modifications for speed-up. Some executable files (mex) do not work properly on new versions of OSX. A newer version of the executable can be obtained from a recent SPM12 release.
* The _face_ tissue on the second tissue probability map can be modified to remove other parts of the head. The original map must be in MNI space, and SPM12 code usually does a good work with the transformation.
